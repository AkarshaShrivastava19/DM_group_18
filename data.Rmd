---
output: html_document
date: "2024-03-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment = NA)
library(readr)
```

# The readr package 
```{r}
library(readr)
library(RODBC)
```


# List of files 
```{r readr,attr.source='.numberLines'}
all_files <- list.files("data_upload/")
all_files

```

#Cheking number of rows and columns in each file
```{r loop,message=FALSE,warning=FALSE,attr.source='.numberLines'}
#listing all files 
all_files <- list.files("data_upload/")

#Creating a loop to read all files
for (variable in all_files) {
  filepath <- paste0("data_upload/",variable)
  file_contents <- readr::read_csv(filepath)
  
  number_of_rows <- nrow(file_contents)
  number_of_columns <- ncol(file_contents)

#Printing the number of rows and columns in each file  
  print(paste0("The file: ",variable,
              " has: ",
              format(number_of_rows,big.mark = ","),
              " rows and ",
              number_of_columns," columns"))

  number_of_rows <- nrow(file_contents)
  
  print(paste0("Checking for file: ",variable))

  
#Printing True if the first column is the primary key column else printing False  
  print(paste0(" is ",nrow(unique(file_contents[,1]))==number_of_rows))
}


```

#Creating database connection
```{r loadsqlite,warning=FALSE,error=FALSE,message=FALSE,attr.source='.numberLines'}
# Create a connection
connection <- RSQLite::dbConnect(RSQLite::SQLite(),"ecomdata.db")
RSQLite::dbListTables(connection)
connection <- dbConnect(SQLite(),"ecomdata.db")
```
##Creating table Schema for all tables

#Creating Customer Table
```{sql, eval=FALSE, connection = connection}

CREATE TABLE IF NOT EXISTS customer ( 

    customer_id INT PRIMARY KEY, 
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL, 
    email VARCHAR(50) NOT NULL, 
    gender VARCHAR(50) NOT NULL,
    age INT NOT NULL,
    career VARCHAR(50) NOT NULL,
    customer_phone VARCHAR(20) NOT NULL, 
    address_country VARCHAR(50) NOT NULL,
    address_zipcode VARCHAR(20) NOT NULL,
    address_city VARCHAR(20) NOT NULL,
    address_street VARCHAR(50) NOT NULL,
    referred_by VARCHAR(20) NULL
    
);
```

#Creating Supplier Table
```{sql, eval=FALSE, connection = connection}
CREATE TABLE IF NOT EXISTS supplier ( 

    supplier_id VARCHAR(50) PRIMARY KEY, 
    supplier_name VARCHAR(50) NOT NULL
    );
```


#Creating Category Table
```{sql, eval=FALSE, connection = connection}
CREATE TABLE IF NOT EXISTS category ( 

    category_id VARCHAR(20) PRIMARY KEY, 
    category_name VARCHAR(50) NOT NULL

);

```

#Creating Delivery Table
```{sql, eval=FALSE, connection = connection}
CREATE TABLE IF NOT EXISTS delivery ( 

    delivery_id VARCHAR(20) PRIMARY KEY, 
    customer_id VARCHAR(20) NOT NULL,
    delivery_status VARCHAR(20) NOT NULL,
    customer_name VARCHAR(20) NOT NULL,
    FOREIGN KEY ('customer_id') REFERENCES customer('customer_id')

);

```

#Creating Promotion Table
```{sql, eval=FALSE, connection = connection}
CREATE TABLE IF NOT EXISTS promotion ( 

    promotion_id VARCHAR(20) PRIMARY KEY, 
    promotion_name VARCHAR(20) NOT NULL,
    promotion_start_date DATE NOT NULL,
    promotion_end_date DATE NOT NULL,
    promotion_discount_value FLOAT NOT NULL

);

```

#Creating Product Table
```{sql, eval=FALSE, connection = connection}
CREATE TABLE IF NOT EXISTS product ( 

    product_id VARCHAR(50) PRIMARY KEY, 
    category_id VARCHAR(50) NOT NULL,
    supplier_id VARCHAR(50) NOT NULL, 
    promotion_id VARCHAR(50) NULL, 
    product_name VARCHAR(50) NOT NULL,
    price INT NOT NULL,
    quantity_stock INT NOT NULL,
    quantity_supplied INT NOT NULL, 
    review_score FLOAT NOT NULL,
    FOREIGN KEY ('category_id') REFERENCES category('category_id'), 
    FOREIGN KEY ('supplier_id') REFERENCES supplier('supplier_id'), 
    FOREIGN KEY ('promotion_id') REFERENCES promotion('promotion_id')     
   
);

```

#Creating Orders Table
```{sql, eval=FALSE, connection = connection}

CREATE TABLE IF NOT EXISTS orders ( 

    order_id VARCHAR(50) NOT NULL, 
    product_id VARCHAR(20) NOT NULL,
    customer_id VARCHAR(50) NOT NULL,
   /*quantity INT NOT NULL,
   refund_status BOOLEAN NOT NULL, */
    FOREIGN KEY ('customer_id') REFERENCES customer('customer_id'), 
    FOREIGN KEY ('product_id') REFERENCES product('product_id'),
    PRIMARY KEY (order_id,product_id,customer_id)


);

```

#Listing tables from the database that we created

```{r listtables}

RSQLite::dbListTables(connection)

```

#Loading data from csv to database tables
```{r loadsqlite,warning=FALSE,error=FALSE,message=FALSE}

load_data_to_db <- function(filename, db_table_name, connection) {
  data <- read.csv(filename)
  dbWriteTable(connection, db_table_name, data, append = TRUE, row.names = FALSE)
}

customer_table <- read.csv('data_upload/customer.csv')
load_data_to_db("customer_table", "customer",connection)
load_data_to_db("data_upload/supplier.csv", "supplier", connection)
load_data_to_db("data_upload/category.csv", "category", connection)
load_data_to_db("data_upload/delivery.csv", "delivery", connection)
load_data_to_db("data_upload/promotion.csv", "promotion", connection)
load_data_to_db("data_upload/product.csv", "product", connection)

```


#Disconnecting from Database
```{r disconnect}
RSQLite::dbDisconnect(connection)

```

#Storing data in RDS format
```{r rdata,message=FALSE,warning=FALSE,attr.source='.numberLines'}
all_files <- list.files("data_upload/")
for (variable in all_files) {
  filepath <- paste0("data_upload/",variable)
  file_contents <- readr::read_csv(filepath)
  table_name <- gsub(".csv","",variable)
  save(file_contents,file = paste0("rdadata/",table_name,".rds"))
}

```


```{sql, eval=FALSE, connection = connection}


INSERT INTO orders (order_id, product_id, customer_id, quantity, refund_status)
SELECT
    CONCAT('order_', p.product_id, '_', c.customer_id) AS order_id,
    p.product_id,
    c.customer_id,
    p.quantity_stock,  -- You might adjust this based on your logic
    FALSE AS refund_status  -- Assuming no refunds initially
FROM
    customer c
CROSS JOIN
    product p;


```



